<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Standardized Validation Rule API &#8212; PHES-ODM Validation  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=bf1bc15e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/odm-styles.css?v=c2e4d323" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Versioning" href="versioning.html" />
    <link rel="prev" title="Validate Tool" href="validate-tool.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="standardized-validation-rule-api">
<h1>Standardized Validation Rule API<a class="headerlink" href="#standardized-validation-rule-api" title="Link to this heading">¶</a></h1>
<p>This document will go over the design for a standardized API to define
validation rules in the library. It will also provide reasoning for some
of the design decisions made.</p>
<section id="audience">
<h2>Audience<a class="headerlink" href="#audience" title="Link to this heading">¶</a></h2>
<p>The primary audience for this document are the developers of the
validation library.</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Link to this heading">¶</a></h2>
<p>Adding a new validation rule in the library cannot currently be done in
an isolated manner. Programming the different pieces that goes into a
new rule more often than not requires modifying multiple files in the
library. In addition, the code in these files are not directly related
to the rule itself.</p>
<p>For example, the code for the <code class="docutils literal notranslate"><span class="pre">duplicate_entries_found</span></code> rule is in
multiple spots in the library. The schema generation is in one file, and
the validation logic/error generation is in another. Worse, its not
intuitive which parts of these files are immediately related to the
rule.</p>
<p>There is a growing need to enable the users of the library to create
their own rules. Users of the ODM come from a variety of backgrounds,
disciplines, and professions. Trying to accomodate all the validation
needs of such a diverse group of individuals is not possible, hence the
need for a better way to implement rules.</p>
<p>Keeping the above in mind, the goal of of this document is to specify a
standardized, intuitive, and isolated API for the creation of validation
rules. This API should work not only for the core set of rules included
with the library, but for any future rules that need to be implemented.</p>
</section>
<section id="design-approach">
<h2>Design Approach<a class="headerlink" href="#design-approach" title="Link to this heading">¶</a></h2>
<p>The design for this API was developed by:</p>
<ol class="arabic simple">
<li><p>Going through all the rules currently implemented in the library as
well as certain new rules that users have asked for;</p></li>
<li><p>Identifying the common elements between the rules; and</p></li>
<li><p>Developing an API to expose those elements to a user, in a way that
works for all of the rules</p></li>
</ol>
<p>The common elements or processes involved in each rule are explained
below.</p>
<section id="rule-processes">
<h3>Rule processes<a class="headerlink" href="#rule-processes" title="Link to this heading">¶</a></h3>
<p>At a high level, implementing a new rule requires the following two
processes:</p>
<ol class="arabic simple">
<li><p>Generating a schema; and</p></li>
<li><p>Validating data using the generated schema</p></li>
</ol>
<p>There are other details that need to be thought off, for example,
generating errors for the validation report, but they are all within the
context of the above two processes.</p>
<section id="generating-a-schema">
<h4>Generating a schema<a class="headerlink" href="#generating-a-schema" title="Link to this heading">¶</a></h4>
<p>Generating a schema means returning the information needed by the rule
to perform its validation during the validation process.</p>
<p>The rule needs to generate a schema for every table-column pair in the
ODM dictionary. Certain table-column pairs may not be applicable to a
rule, which the design needs to keep in mind.</p>
<p>The metadata needed to generate a schema will most probably come from an
outside source. Currently, all this metadata comes from the ODM
dictionary excel sheet.</p>
<p>For example, consider the <code class="docutils literal notranslate"><span class="pre">greater_than_max_length</span></code> rule. It needs to
know what the max length is for a particular value in order to implement
its validation logic. In addition, the rule only applies to string
columns with a defined max length. Finally, all the information needed
to generate this rule comes from the <code class="docutils literal notranslate"><span class="pre">maxLength</span></code> column of a part,
locatedin the <code class="docutils literal notranslate"><span class="pre">parts</span></code> sheet in the ODM dictionary.</p>
<p>Take a look at the parts sheet below,</p>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-style: italic">                                                    Parts Sheet                                                    </span>
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> partID          </span>┃<span style="font-weight: bold"> partType             </span>┃<span style="font-weight: bold"> sites         </span>┃<span style="font-weight: bold"> dataType         </span>┃<span style="font-weight: bold"> maxValue         </span>┃<span style="font-weight: bold"> maxLength        </span>┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ sites           │ tables               │ NA            │ NA               │ NA               │ NA               │
│ siteID          │ attributes           │ pK            │ varchar          │ NA               │ 6                │
│ geoLat          │ attributes           │ header        │ integer          │ 90               │ NA               │
│ geoLong         │ attributes           │ header        │ integer          │ 90               │ NA               │
└─────────────────┴──────────────────────┴───────────────┴──────────────────┴──────────────────┴──────────────────┘
</pre>
<p>It defines 4 parts:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">sites</span></code> table;</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">siteID</span></code> string column, part of the <code class="docutils literal notranslate"><span class="pre">sites</span></code> table;</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">geoLat</span></code> integer column, part of the <code class="docutils literal notranslate"><span class="pre">sites</span></code> table; and</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">geoLong</span></code> integer column, part of the <code class="docutils literal notranslate"><span class="pre">sites</span></code> table</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">greater_than_max_length</span></code> rule would generate a schema only for the
<code class="docutils literal notranslate"><span class="pre">siteID</span></code> column in the <code class="docutils literal notranslate"><span class="pre">sites</span></code> table. The schema would include its
<code class="docutils literal notranslate"><span class="pre">maxLength</span></code> value of <strong>6</strong>.</p>
</section>
<section id="validating-data">
<h4>Validating data<a class="headerlink" href="#validating-data" title="Link to this heading">¶</a></h4>
<p>Validating data means asking the rule if a value in a dataset is valid,
according to the information returned in the schema generation process.</p>
<p>For example, for the dataset below,</p>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-style: italic">                                                    Sites Table                                                    </span>
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> siteID                                </span>┃<span style="font-weight: bold"> geoLat                           </span>┃<span style="font-weight: bold"> geoLong                              </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 1234567                               │ 91                               │ 89                                   │
│ 2                                     │ 89                               │ 91                                   │
└───────────────────────────────────────┴──────────────────────────────────┴──────────────────────────────────────┘
</pre>
<p>the validation logic for the <code class="docutils literal notranslate"><span class="pre">greater_than_max_length</span></code> rule would be run
for all values in the <code class="docutils literal notranslate"><span class="pre">siteID</span></code> column.</p>
<p><strong>This step is optional if the desired validation can be done by
cerberus</strong></p>
</section>
</section>
</section>
<section id="specifications">
<h2>Specifications<a class="headerlink" href="#specifications" title="Link to this heading">¶</a></h2>
<p>These next few sections will go over the different elements of the API.</p>
<p>Keep in mind that the library uses
<a class="reference external" href="https://docs.python-cerberus.org/en/stable/">cerberus</a> as its
validation engine. Some of its idiosyncrancies may leak into the design.</p>
<section id="the-validationrule-class">
<h3>The <code class="docutils literal notranslate"><span class="pre">ValidationRule</span></code> class<a class="headerlink" href="#the-validationrule-class" title="Link to this heading">¶</a></h3>
<p>This is an <strong>abstract</strong> class that every validation rule that can be
used with the library will need to extend.</p>
<p>By using an abstract class it becomes clear what methods need to be
implemented when programming a new rule. Run-time checks that show
errors if all methods are not implemented can be shown to the user.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ValidationRule</span></code> class has the following methods:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">validate_data</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gen_report</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transformed</span></code></p></li>
</ol>
<p>The first two methods are used in the schema generation process while
the other three methods are used in the validation process.</p>
<p>In the following sections we will go over the listed methods in detail.</p>
<p><strong>Every method by default takes the Python <code class="docutils literal notranslate"><span class="pre">self</span></code> parameter as its first
argument. Its presence is assumed and will not be mentioned unless
warranted.</strong></p>
</section>
<section id="get-schema-keys-and-gen-schema-values">
<h3><code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> and <code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code><a class="headerlink" href="#get-schema-keys-and-gen-schema-values" title="Link to this heading">¶</a></h3>
<p>These two functions are used in the schema generation process and are
together used to construct the schema for a rule. The schema for a rule
is an object that contains key-value pairs, where each key is the unique
name for a piece of validation metadata, and the value contains the
metadata.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> method does not take any parameters and should
return a list of strings that represents the keys.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code> method takes the following 4 parameters:</p>
<ol class="arabic simple">
<li><p>The name of the <strong>table</strong> to generate the schema values for;</p></li>
<li><p>The name of the <strong>column</strong> in the above table to generate the schema
values for;</p></li>
<li><p>An object that represents the <strong>ODM dictionary</strong> the schema is for.
This can be used to generate the schema values for the provided
table-column pair.</p></li>
<li><p>An object which contains metadata about the current generation
process. It should contain the following metadata:</p>
<ol class="arabic simple">
<li><p>The version of the dictionary the schema is for</p></li>
</ol>
</li>
</ol>
<p>The method should return one of the following values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> if the table-column pair is not applicable for the rule; or</p></li>
<li><p>A list of schema values, each of which matches up with the keys
returned in the <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> method</p></li>
</ul>
<p>For example, for the <code class="docutils literal notranslate"><span class="pre">greater_than_max_length</span></code> rule:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">gen_schema_keys</span></code> method would return the list <code class="docutils literal notranslate"><span class="pre">['maxlength']</span></code>;
and</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code> method would return the list <code class="docutils literal notranslate"><span class="pre">[6]</span></code> for the
<code class="docutils literal notranslate"><span class="pre">siteID</span></code> column and <code class="docutils literal notranslate"><span class="pre">None</span></code> otherwise</p></li>
</ol>
<p>Similiarly, if we were to implement the two methods for the
<code class="docutils literal notranslate"><span class="pre">greater_than_max_value</span></code> rule with the parts sheet displayed above:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> method would return the list
<code class="docutils literal notranslate"><span class="pre">['type',</span> <span class="pre">'coerce',</span> <span class="pre">'max']</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code> method would return the list
<code class="docutils literal notranslate"><span class="pre">['integer',</span> <span class="pre">'integer',</span> <span class="pre">90]</span></code><br />
for the <code class="docutils literal notranslate"><span class="pre">geoLat</span></code> and <code class="docutils literal notranslate"><span class="pre">geoLong</span></code> columns. It would return <code class="docutils literal notranslate"><span class="pre">None</span></code> for
the other columns.</p></li>
</ol>
<p>Due to the seperation of the schema generation and validation processes,
the schema generation process cannot be combined into one method. This
is explained <a class="reference external" href="#two-methods-for-schema-generation">below</a>.</p>
<section id="validate-data">
<h4><code class="docutils literal notranslate"><span class="pre">validate_data</span></code><a class="headerlink" href="#validate-data" title="Link to this heading">¶</a></h4>
<p>This method is <strong>optional</strong>. A rule can decide to implement it if
nothing in cerberus meets its needs. It can also be used to override a
cerberus rule.</p>
<p><strong>If this method is implemented, then the <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> method
should only return one key. This is for ease of implementation since
there are currently no uses cases for custom validation with multiple
schema keys.</strong></p>
<p>The method takes the following 3 parameters:</p>
<ol class="arabic simple">
<li><p>The value to be validated.</p></li>
<li><p>The schema information to validate this value with. This is the
schema value that the rule returned in their <code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code>
method for the table-column pair that the value belongs to.</p></li>
<li><p>An object that contains metadata about the value. It should include
the following:</p>
<ol class="arabic simple">
<li><p>The row that the value belongs to</p></li>
<li><p>The row index</p></li>
<li><p>The name of the column</p></li>
<li><p>The name of the table</p></li>
</ol>
</li>
</ol>
<p>The method should return a boolean, <code class="docutils literal notranslate"><span class="pre">True</span></code> if the value passed
validation, and <code class="docutils literal notranslate"><span class="pre">False</span></code> otherwise.</p>
<p>For example, with the <code class="docutils literal notranslate"><span class="pre">greater_than_max_length</span></code> rule and the <code class="docutils literal notranslate"><span class="pre">sites</span></code>
table printed above, the <code class="docutils literal notranslate"><span class="pre">validate_data</span></code> method would be called twice
for each row of the <code class="docutils literal notranslate"><span class="pre">sites</span></code> table with the parameters below. Each item
in the list corresponds to each call of the <code class="docutils literal notranslate"><span class="pre">validate_data</span></code> method.</p>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'1234567'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'data_context'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1234567'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'siteID'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'1'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'data_context'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'siteID'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>
<span style="font-weight: bold">]</span>
</pre>
</section>
<section id="gen-report">
<h4><code class="docutils literal notranslate"><span class="pre">gen_report</span></code><a class="headerlink" href="#gen-report" title="Link to this heading">¶</a></h4>
<p>This method is used by the rule to return a machine actionable object
for every failed validation. Each of these objects will be included in
the final validation report.</p>
<p>It takes the following parameters:</p>
<ol class="arabic simple">
<li><p>The value that failed validation</p></li>
<li><p>An object that contains metadata about the failed validation. The
metadata includes:</p>
<ol class="arabic simple">
<li><p>The name of the table the failed value is from</p></li>
<li><p>The index of the row the failed value is from</p></li>
<li><p>The name of the column the failed value is from</p></li>
<li><p>The row object where the failed value is from</p></li>
<li><p>The name of the schema key that failed validation</p></li>
<li><p>The value of the schema key</p></li>
</ol>
</li>
</ol>
<p>The method can return <code class="docutils literal notranslate"><span class="pre">None</span></code> or a <a class="reference external" href="#the-report-object"><code class="docutils literal notranslate"><span class="pre">report</span> <span class="pre">object</span></code></a>.</p>
<p>A rule can return <code class="docutils literal notranslate"><span class="pre">None</span></code>, for example, to avoid duplicate errors in the
report. For example, with the <code class="docutils literal notranslate"><span class="pre">greater_than_max_value</span></code> rule, the
<code class="docutils literal notranslate"><span class="pre">gen_report</span></code> method could return an object only for the <code class="docutils literal notranslate"><span class="pre">max</span></code> schema
key.</p>
<p>For example, for the <code class="docutils literal notranslate"><span class="pre">greater_than_max_value</span></code> rule, this method would be
called twice, once for the <code class="docutils literal notranslate"><span class="pre">geoLat</span></code> column value in row 1 and once for
the <code class="docutils literal notranslate"><span class="pre">geoLong</span></code> value in row 2.</p>
<p>It would be called with the following parameters below. Each item in the
list has the parameters for each call of the <code class="docutils literal notranslate"><span class="pre">gen_report</span></code> method.</p>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'error_context'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1234567'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema_key'</span>: <span style="color: #008000; text-decoration-color: #008000">'min'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">90</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'error_context'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema_key'</span>: <span style="color: #008000; text-decoration-color: #008000">'min'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'schema_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">90</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>
<span style="font-weight: bold">]</span>
</pre>
</section>
<section id="transformed">
<h4><code class="docutils literal notranslate"><span class="pre">transformed</span></code><a class="headerlink" href="#transformed" title="Link to this heading">¶</a></h4>
<p>This is an optional method used to inform the rule when a value has been
transformed. Its useful only if the cerberus <code class="docutils literal notranslate"><span class="pre">coerce</span></code> rule is used.</p>
<p>It takes three parameters:</p>
<ol class="arabic simple">
<li><p>The transformed value</p></li>
<li><p>The original value</p></li>
<li><p>An object that includes metadata about the transformed value. The
metadata includes:</p>
<ol class="arabic simple">
<li><p>The name of the table the value is from</p></li>
<li><p>The index of the row the value is from</p></li>
<li><p>The name of the column the value is from</p></li>
<li><p>An object containing the row the value is from</p></li>
</ol>
</li>
</ol>
<p>The method can return <code class="docutils literal notranslate"><span class="pre">None</span></code> or a <a class="reference external" href="#the-report-object"><code class="docutils literal notranslate"><span class="pre">report</span> <span class="pre">object</span></code></a>.</p>
<p>For example, for the same <code class="docutils literal notranslate"><span class="pre">sites</span></code> table and the <code class="docutils literal notranslate"><span class="pre">greater_than_max_value</span></code>
rule, this method would be called four times, for the two values in the
<code class="docutils literal notranslate"><span class="pre">geoLat</span></code> and <code class="docutils literal notranslate"><span class="pre">geoLong</span></code> column.</p>
<p>The parameters for each call are printed in the list below. Each list
item corresponds to each call.</p>
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'orig_value'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_ctx'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1234567'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">89</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'orig_value'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_ctx'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1234567'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">89</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'orig_value'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_ctx'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_value'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">91</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'orig_value'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="color: #008000; text-decoration-color: #008000">'trans_ctx'</span>: <span style="font-weight: bold">{</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'table'</span>: <span style="color: #008000; text-decoration-color: #008000">'sites'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row_num'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'column'</span>: <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>,
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   │   </span><span style="color: #008000; text-decoration-color: #008000">'row'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'siteID'</span>: <span style="color: #008000; text-decoration-color: #008000">'1'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLat'</span>: <span style="color: #008000; text-decoration-color: #008000">'89'</span>, <span style="color: #008000; text-decoration-color: #008000">'geoLong'</span>: <span style="color: #008000; text-decoration-color: #008000">'91'</span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   │   </span><span style="font-weight: bold">}</span>
<span style="color: #7fbf7f; text-decoration-color: #7fbf7f">│   </span><span style="font-weight: bold">}</span>
<span style="font-weight: bold">]</span>
</pre>
<p>This method was added due to the <code class="docutils literal notranslate"><span class="pre">less_than_min_value</span></code> and
<code class="docutils literal notranslate"><span class="pre">greater_than_max_value</span></code> rules, where we needed to show warnings to the
user if a successful coercion took place.</p>
</section>
<section id="two-methods-for-schema-generation">
<h4>Two methods for schema generation?<a class="headerlink" href="#two-methods-for-schema-generation" title="Link to this heading">¶</a></h4>
<p>The functionality of <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code> could be rolled into
<code class="docutils literal notranslate"><span class="pre">gen_schema_values</span></code>, so that the latter method now returns the entire
schema object, with keys and values.</p>
<p>This is not possible because of the way the <code class="docutils literal notranslate"><span class="pre">validate_data</span></code> and
<code class="docutils literal notranslate"><span class="pre">gen_report</span></code> methods work. For both these methods the library needs to
know the schema keys that map to each rule:</p>
<ol class="arabic simple">
<li><p>If a rule implements its own <code class="docutils literal notranslate"><span class="pre">validate_data</span></code> method, the library
needs to attach that method to cerberus, with the schema key
associated with it.</p></li>
<li><p>For the <code class="docutils literal notranslate"><span class="pre">gen_report</span></code> method, the library needs to know how to map
each cerberus error object to the rule it belongs to. It uses the
schema key for this.</p></li>
</ol>
<p>If there was only one schema generation method, the library could not
rely on it to always return a schema object, since most rules are not
applicable to all table-column pairs.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">get_schema_keys</span></code>, the library can always know what schema keys
belong to a rule.</p>
</section>
<section id="working-with-self">
<h4>Working with <code class="docutils literal notranslate"><span class="pre">self</span></code><a class="headerlink" href="#working-with-self" title="Link to this heading">¶</a></h4>
<p>Certain rules need to keep track of information between method calls.</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">duplicate_entries_found</span></code> rule needs to keep track of
all primaryKey-lastUpdated pairs it encounters during the validation
process. It uses this information to check whether a new value is unique
within a table, or if it has been encountered before.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">self</span></code> parameter allows a rule to keep track of whatever <strong>state</strong>
information it needs between calls of the different methods.</p>
<p>For example, for the <code class="docutils literal notranslate"><span class="pre">duplicate_entries_found</span></code> rule, it can keep track
of each primaryKey-lastUpdated pair in <code class="docutils literal notranslate"><span class="pre">self</span></code> whenever <code class="docutils literal notranslate"><span class="pre">validate_data</span></code>
is called. It can then refer to that field when validating a new pair to
check if it is unique or not.</p>
</section>
<section id="the-report-object">
<h4>The Report object<a class="headerlink" href="#the-report-object" title="Link to this heading">¶</a></h4>
<p>Within the <code class="docutils literal notranslate"><span class="pre">gen_report</span></code> and <code class="docutils literal notranslate"><span class="pre">transformed</span></code> functions the validation rule
can decide to return an object that represents an error/warning report.</p>
<p>Depending on whether the report is an error or a warning the <code class="docutils literal notranslate"><span class="pre">errorType</span></code>
or <code class="docutils literal notranslate"><span class="pre">warningType</span></code> field should be set, with <code class="docutils literal notranslate"><span class="pre">errorType</span></code> being for the
former and <code class="docutils literal notranslate"><span class="pre">warningType</span></code> being for the latter.</p>
<p>If the report is an error then it should be added to the errors list in
the report and if it is warning it should be to the warnings list.</p>
<p>Finally, the validation rule is allowed to add any other metadata it
deems necessary to the report object, for example, the offending
value(s).</p>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ODM-logo.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">PHES-ODM Validation</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../examples/tutorial.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/explanation-document/explanation-document.html">Getting to know the validation library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/schema-additions/schema-additions.html">Customizing a Validation Schema</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api.html">API Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api.html#module-odm_validation.validation">Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api.html#module-odm_validation.utils">Utils</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../api.html#specification">Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rules.html">Validation rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links/contributing_link.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links/code_of_conduct_link.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links/license_link.html">License</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../api.html">API Documentation</a><ul>
      <li>Previous: <a href="validate-tool.html" title="previous chapter">Validate Tool</a></li>
      <li>Next: <a href="versioning.html" title="next chapter">Versioning</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, OHRI.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/specs/validation-rule.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>